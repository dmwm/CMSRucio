apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "rucio-consistency.fullname" . }}-crontab
data:
  consistency-crontab: |+
    # This is an auto-generated crontab. 
    # It uses "DeterministicDelay" to space out the running of jobs within the interval specified.
    # The deterministic delay script is at {{ $.Values.consistency.detDelay }}
    SHELL=/bin/sh
    PATH=/root/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    
    # Special scripts
     0  0 * * * root /consistency/cleanup.sh
     5  0 * * 5 root /consistency/RAL_Disk_pre.sh
    30 23 * * 5 root /consistency/RAL_Disk_post.sh
    10  0 * * 3 root /consistency/RAL_Tape_pre.sh
    20 23 * * 3 root /consistency/RAL_Tape_post.sh

    # Auto generated by looping over .Values.consistency.sites from the helm chart
{{- range $site, $config := .Values.consistency.sites }}
{{ if gt $config.interval 0.0 }}
    0 0 * * * root {{ $.Values.consistency.detDelay }} -d {{ $config.interval }}d -f 1d /consistency/site.sh {{ $site }}
    0 0 * * * root {{ $.Values.consistency.detDelay }} -d {{ $config.interval }}d -f 1d /consistency/unmerged_site.sh {{ $site }}
{{- end }}
{{- end }}
