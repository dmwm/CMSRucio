{{- if .Values.wfDashboard.enabled }}
{{- $fullName := include "rucio-cron-jobs.fullname" . -}}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-wf-dashboard
  labels:
    {{- include "rucio-cron-jobs.labels" . | nindent 4 }}
spec:
  schedule: "20 4 * * *"
  jobTemplate:
    spec:
      activeDeadlineSeconds: 14400
      backoffLimit: 0
      template:
        spec:
          volumes:
          - name: proxy-volume
            secret:
              defaultMode: 400
              secretName: server-rucio-x509up
          {{- range $key, $val := .Values.wfDashboard.persistentVolumes }}
          - name: {{ $key }}
            persistentVolumeClaim:
              claimName: {{ $val.name }}
          {{- end}}
          containers:
            - name: {{ .Release.Name }}-wf-dashboard
              image: registry.cern.ch/cmsrucio/wf-dashboard:release-0.9
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              volumeMounts:
                - mountPath: /opt/proxy
                  name: proxy-volume
              env: 
                - name: X509_USER_PROXY
                  value: "/opt/proxy/x509up"
{{- with .Values.cronjobSettings.additionalEnvs }}
{{ toYaml . | indent 16 }}
{{- end }}
              command: ['/entrypoint.sh']
          restartPolicy: Never
{{- end }}
